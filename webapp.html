<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="source/style/webapp.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Michroma&family=Oswald:wght@200..700&display=swap" rel="stylesheet">
    <style>
    .leaderboard{
        width: auto;
    }
    </style>
</head>

<body>
    <div class="main-content">
        <header class="fixed-header">
            <div class="header">
                <p class="onion"><img src="source/images/onion.png" style="height: 30px;" alt="Onion"> <span id="onion">0</span></p>
                <p class="candy"><img src="source/images/candy30x30.png" alt="Candy"> <span id="candy">0</span></p>
                <p class="junk"><img src="source/images/Junk.png" style="height: 25px;" alt="junk"><span id="junk">0</span></p>
                <p class="coin"><img src="source/images/golden onion coin420x420.png" style="height: 26px;" alt="Coin"> <span id="coin">0</span></p>
            </div>
        </header>
        
        <div class="margintop"></div>

        <section>
            <div class="container">
                <div class="slider-container">
                    <div id="sliderTrack" class="slider-track"></div>
                    <div class="slider-center-frame"></div>
                </div>
                <button class="spinbtn" id="spinBtn">Spin</button>
                <h2>üèÜ Leaderboard</h2>
                <table class="leaderboard">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Username</th>
                            <th id="header-onion">Onion üßÖ</th>
                            <th id="header-streak">üî•</th>
                            <th id="header-referrals">üë•</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        <tr><td colspan="5">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <div id="modal">
            <div id="modal-content">
                <p id="modal-text"></p>
                <button id="close-modal">Close</button>
            </div>
        </div>
    </div>

    <footer class="fixed-footer">
        <div class="buttons">
            <a class="fbtn" href="webapp.html">Slider</a>
            <a class="fbtn" href="frends.html">Friends</a>
            <a class="fbtn rpg-btn" href="source/rpg.html?v=1.1.32">RPG</a>
            <a class="fbtn" href="earn.html">Earn</a>
            <a class="fbtn disabled" href="#" onclick="return false;">Play</a>
        </div>
    </footer>

    <script>

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è IndexedDB –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const initUserResourcesDB = () => {
        return new Promise((resolve, reject) => {
            console.log('[IndexedDB] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤...');
            
            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤–µ—Ä—Å–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
            const request = indexedDB.open('UserResourcesDB', 10);
            
            request.onerror = (event) => {
                console.error('[IndexedDB] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:', event.target.error);
                reject(event.target.error);
            };
            
            request.onblocked = (event) => {
                console.warn('[IndexedDB] –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞. –ó–∞–∫—Ä–æ–π—Ç–µ –¥—Ä—É–≥–∏–µ –≤–∫–ª–∞–¥–∫–∏ —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.');
                // –ü—ã—Ç–∞–µ–º—Å—è —É–¥–∞–ª–∏—Ç—å –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –±–∞–∑—É
                try {
                    indexedDB.deleteDatabase('UserResourcesDB');
                    console.log('[IndexedDB] –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–¥–∞–ª–µ–Ω–∞ –ø–æ—Å–ª–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.');
                } catch (e) {
                    console.error('[IndexedDB] –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:', e);
                }
                reject(new Error('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞'));
            };
            
            request.onupgradeneeded = (event) => {
                console.log('[IndexedDB] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–æ –≤–µ—Ä—Å–∏–∏ 3...');
                const db = event.target.result;
                
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞, –µ—Å–ª–∏ –æ–Ω–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
                if (db.objectStoreNames.contains('resources')) {
                    db.deleteObjectStore('resources');
                    console.log('[IndexedDB] –£–¥–∞–ª–µ–Ω–æ —Å—Ç–∞—Ä–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ "resources"');
                }
                if (db.objectStoreNames.contains('resourcesLog')) {
                    db.deleteObjectStore('resourcesLog');
                    console.log('[IndexedDB] –£–¥–∞–ª–µ–Ω–æ —Å—Ç–∞—Ä–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ "resourcesLog"');
                }
                
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —è–≤–Ω—ã–µ –∫–ª—é—á–∏ (keyPath) –∏ —Å—Ç—Ä–æ–∫–æ–≤—ã–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã
                const resourcesStore = db.createObjectStore('resources', { keyPath: 'id' });
                resourcesStore.createIndex('telegramId', 'telegramId', { unique: true });
                console.log('[IndexedDB] –°–æ–∑–¥–∞–Ω–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ "resources" —Å –∫–ª—é—á–æ–º id');
                
                const logsStore = db.createObjectStore('resourcesLog', { autoIncrement: true });
                logsStore.createIndex('telegramId', 'telegramId', { unique: false });
                logsStore.createIndex('timestamp', 'timestamp', { unique: false });
                console.log('[IndexedDB] –°–æ–∑–¥–∞–Ω–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ "resourcesLog" —Å –∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–Ω—ã–º –∫–ª—é—á–æ–º');
            };
            
            request.onsuccess = (event) => {
                const db = event.target.result;
                console.log('[IndexedDB] –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä—ã—Ç–∞. –í–µ—Ä—Å–∏—è:', db.version);
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â
                const storeNames = Array.from(db.objectStoreNames);
                console.log('[IndexedDB] –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞:', storeNames);
                
                if (!storeNames.includes('resources') || !storeNames.includes('resourcesLog')) {
                    console.error('[IndexedDB] –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ó–∞–∫—Ä—ã—Ç–∏–µ –ë–î –∏ —É–¥–∞–ª–µ–Ω–∏–µ.');
                    db.close();
                    
                    const deleteRequest = indexedDB.deleteDatabase('UserResourcesDB');
                    deleteRequest.onsuccess = () => {
                        console.log('[IndexedDB] –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–¥–∞–ª–µ–Ω–∞ –ø–æ—Å–ª–µ –Ω–µ—É–¥–∞—á–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏.');
                        reject(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞'));
                    };
                    deleteRequest.onerror = (e) => {
                        console.error('[IndexedDB] –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:', e.target.error);
                        reject(e.target.error);
                    };
                    return;
                }
                
                resolve(db);
            };
        });
    };
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ IndexedDB
    const saveUserResources = async (telegramId, resources) => {
        try {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ telegramId
            if (!telegramId) {
                console.error('[IndexedDB] –û—à–∏–±–∫–∞: telegramId –Ω–µ —É–∫–∞–∑–∞–Ω');
                throw new Error('telegramId –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö');
            }
            
            // –ü—Ä–∏–≤–æ–¥–∏–º telegramId –∫ —Å—Ç—Ä–æ–∫–µ –∏ —Å–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π id –∑–∞–ø–∏—Å–∏
            const telegramIdStr = String(telegramId);
            const resourceId = `user_${telegramIdStr}`;
            
            console.log(`[IndexedDB] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ —Å id=${resourceId} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${telegramIdStr}:`, resources);
            
            const db = await initUserResourcesDB();
            
            return new Promise((resolve, reject) => {
                try {
                    const transaction = db.transaction(['resources', 'resourcesLog'], 'readwrite');
                    
                    transaction.onerror = (event) => {
                        console.error('[IndexedDB] –û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:', event.target.error);
                        reject(event.target.error);
                    };
                    
                    const resourcesStore = transaction.objectStore('resources');
                    const logsStore = transaction.objectStore('resourcesLog');
                    
                    // –ß—Ç–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ id
                    const getRequest = resourcesStore.get(resourceId);
                    
                    getRequest.onsuccess = (event) => {
                        try {
                            const currentData = event.target.result;
                            const timestamp = new Date().toISOString();
                            
                            // –°–æ–∑–¥–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç —Ä–µ—Å—É—Ä—Å–æ–≤
                            const resourceData = {
                                id: resourceId,            // –Ø–≤–Ω–æ –∑–∞–¥–∞–µ–º id –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∫–ª—é—á–∞
                                telegramId: telegramIdStr, // –°–æ—Ö—Ä–∞–Ω—è–µ–º telegramId –∫–∞–∫ —Å—Ç—Ä–æ–∫—É
                                ...resources,
                                lastUpdated: timestamp
                            };
                            
                            console.log('[IndexedDB] –û–±—ä–µ–∫—Ç –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', resourceData);
                            
                            // –ï—Å–ª–∏ –µ—Å—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ, —Å–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –ª–æ–≥–∞
                            if (currentData) {
                                console.log('[IndexedDB] –ù–∞–π–¥–µ–Ω—ã —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ:', currentData);
                                
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
                                const hasChanges = Object.keys(resources).some(key => 
                                    resources[key] !== currentData[key]
                                );
                                
                                if (hasChanges) {
                                    // –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π
                                    const changes = {};
                                    Object.keys(resources).forEach(key => {
                                        if (resources[key] !== currentData[key]) {
                                            const oldVal = currentData[key] || 0;
                                            const newVal = resources[key];
                                            const diff = newVal - oldVal;
                                            changes[key] = {
                                                old: oldVal,
                                                new: newVal,
                                                diff: diff
                                            };
                                            console.log(`[IndexedDB] –ò–∑–º–µ–Ω–µ–Ω–∏–µ ${key}: ${oldVal} -> ${newVal} (${diff > 0 ? '+' + diff : diff})`);
                                        }
                                    });
                                    
                                    // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –≤ –ª–æ–≥
                                    const logEntry = {
                                        telegramId: telegramIdStr,
                                        timestamp,
                                        resourceId,
                                        changes,
                                        prevData: { ...currentData },
                                        newData: { ...resourceData }
                                    };
                                    
                                    // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –ª–æ–≥
                                    const addLogRequest = logsStore.add(logEntry);
                                    addLogRequest.onerror = (e) => {
                                        console.error('[IndexedDB] –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ –ª–æ–≥–∞:', e.target.error);
                                    };
                                } else {
                                    console.log('[IndexedDB] –ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ, –∑–∞–ø–∏—Å—å –≤ –ª–æ–≥ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
                                }
                            } else {
                                console.log('[IndexedDB] –î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å');
                                
                                // –ó–∞–ø–∏—Å—å –ª–æ–≥–∞ –¥–ª—è –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏
                                const logEntry = {
                                    telegramId: telegramIdStr,
                                    timestamp,
                                    resourceId,
                                    type: 'initial',
                                    data: { ...resourceData }
                                };
                                
                                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –ª–æ–≥
                                const addLogRequest = logsStore.add(logEntry);
                                addLogRequest.onerror = (e) => {
                                    console.error('[IndexedDB] –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –ª–æ–≥–∞:', e.target.error);
                                };
                            }
                            
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
                            const putRequest = resourcesStore.put(resourceData);
                            
                            putRequest.onsuccess = () => {
                                console.log('[IndexedDB] –†–µ—Å—É—Ä—Å—ã —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã —Å id:', resourceId);
                                resolve(true);
                            };
                            
                            putRequest.onerror = (e) => {
                                console.error('[IndexedDB] –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤:', e.target.error);
                                reject(e.target.error);
                            };
                        } catch (innerError) {
                            console.error('[IndexedDB] –û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', innerError);
                            reject(innerError);
                        }
                    };
                    
                    getRequest.onerror = (e) => {
                        console.error('[IndexedDB] –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', e.target.error);
                        reject(e.target.error);
                    };
                    
                    transaction.oncomplete = () => {
                        console.log('[IndexedDB] –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
                        db.close();
                    };
                } catch (transactionError) {
                    console.error('[IndexedDB] –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:', transactionError);
                    reject(transactionError);
                }
            });
        } catch (error) {
            console.error('[IndexedDB] –û–±—â–∞—è –æ—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
            throw error;
        }
    };
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ IndexedDB
    const getUserResources = async (telegramId) => {
        try {
            if (!telegramId) {
                console.error('[IndexedDB] –û—à–∏–±–∫–∞: telegramId –Ω–µ —É–∫–∞–∑–∞–Ω –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤');
                throw new Error('telegramId –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö');
            }
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º id –∑–∞–ø–∏—Å–∏ –∏–∑ telegramId
            const telegramIdStr = String(telegramId);
            const resourceId = `user_${telegramIdStr}`;
            
            console.log(`[IndexedDB] –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è id=${resourceId}`);
            
            const db = await initUserResourcesDB();
            
            return new Promise((resolve, reject) => {
                try {
                    const transaction = db.transaction('resources', 'readonly');
                    const store = transaction.objectStore('resources');
                    
                    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ id
                    const request = store.get(resourceId);
                    
                    request.onsuccess = (event) => {
                        const result = event.target.result;
                        
                        if (result) {
                            console.log('[IndexedDB] –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å–æ–≤:', result);
                            resolve(result);
                        } else {
                            console.log('[IndexedDB] –†–µ—Å—É—Ä—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è id:', resourceId);
                            resolve(null);
                        }
                    };
                    
                    request.onerror = (e) => {
                        console.error('[IndexedDB] –û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤:', e.target.error);
                        reject(e.target.error);
                    };
                    
                    transaction.oncomplete = () => {
                        db.close();
                    };
                } catch (error) {
                    console.error('[IndexedDB] –û—à–∏–±–∫–∞ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤:', error);
                    reject(error);
                }
            });
        } catch (error) {
            console.error('[IndexedDB] –û–±—â–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤:', error);
            throw error;
        }
    };
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ä–µ—Å—É—Ä—Å–æ–≤
    const getResourcesHistory = async (telegramId, limit = 10) => {
        try {
            if (!telegramId) {
                console.error('[IndexedDB] –û—à–∏–±–∫–∞: telegramId –Ω–µ —É–∫–∞–∑–∞–Ω –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏');
                throw new Error('telegramId –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏');
            }
            
            const telegramIdStr = String(telegramId);
            
            console.log(`[IndexedDB] –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${telegramIdStr}, –ª–∏–º–∏—Ç: ${limit}`);
            
            const db = await initUserResourcesDB();
            
            return new Promise((resolve, reject) => {
                try {
                    const transaction = db.transaction('resourcesLog', 'readonly');
                    const store = transaction.objectStore('resourcesLog');
                    const index = store.index('telegramId');
                    
                    const logs = [];
                    
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—É—Ä—Å–æ—Ä –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö limit –∑–∞–ø–∏—Å–µ–π
                    const request = index.openCursor(IDBKeyRange.only(telegramIdStr), 'prev');
                    
                    request.onsuccess = (event) => {
                        const cursor = event.target.result;
                        
                        if (cursor && logs.length < limit) {
                            logs.push(cursor.value);
                            cursor.continue();
                        } else {
                            console.log(`[IndexedDB] –ü–æ–ª—É—á–µ–Ω–æ ${logs.length} –∑–∞–ø–∏—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏`);
                            resolve(logs);
                        }
                    };
                    
                    request.onerror = (e) => {
                        console.error('[IndexedDB] –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏:', e.target.error);
                        reject(e.target.error);
                    };
                    
                    transaction.oncomplete = () => {
                        db.close();
                    };
                } catch (error) {
                    console.error('[IndexedDB] –û—à–∏–±–∫–∞ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏:', error);
                    reject(error);
                }
            });
        } catch (error) {
            console.error('[IndexedDB] –û–±—â–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
            throw error;
        }
    };
    
    // –û—á–∏—Å—Ç–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö IndexedDB
    const clearIndexedDB = async () => {
        return new Promise((resolve, reject) => {
            console.log('[IndexedDB] –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ—á–∏—Å—Ç–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...');
            
            const deleteRequest = indexedDB.deleteDatabase('UserResourcesDB');
            
            deleteRequest.onsuccess = () => {
                console.log('[IndexedDB] –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞');
                resolve(true);
            };
            
            deleteRequest.onerror = (e) => {
                console.error('[IndexedDB] –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:', e.target.error);
                reject(e.target.error);
            };
            
            deleteRequest.onblocked = () => {
                console.warn('[IndexedDB] –£–¥–∞–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ. –ó–∞–∫—Ä–æ–π—Ç–µ –¥—Ä—É–≥–∏–µ –≤–∫–ª–∞–¥–∫–∏.');
                reject(new Error('–£–¥–∞–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ'));
            };
        });
    };
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ —Å–±—Ä–æ—Å–∞ IndexedDB
    document.addEventListener('DOMContentLoaded', () => {
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        window.resetIndexedDB = async () => {
            try {
                await clearIndexedDB();
                console.log('[IndexedDB] –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω–∞. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã.');
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
                setTimeout(() => window.location.reload(), 1000);
                return true;
            } catch (error) {
                console.error('[IndexedDB] –û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:', error);
                return false;
            }
        };
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è IndexedDB
        window.testIndexedDB = async () => {
            try {
                const telegramId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || localStorage.getItem('telegramId') || "test_user";
                console.log('[IndexedDB] –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', telegramId);
                
                // –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç–æ–≤—ã–π –æ–±—ä–µ–∫—Ç
                const testData = {
                    onion: 123,
                    candy: 45,
                    junk: 67,
                    coin: 8,
                    streak: 9,
                    testField: "–¢–µ—Å—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ " + new Date().toISOString()
                };
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
                await saveUserResources(telegramId, testData);
                
                // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                const retrievedData = await getUserResources(telegramId);
                console.log('[IndexedDB] –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã:', retrievedData);
                
                // –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
                const history = await getResourcesHistory(telegramId, 5);
                console.log('[IndexedDB] –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:', history);
                
                return { saved: testData, retrieved: retrievedData, history };
            } catch (error) {
                console.error('[IndexedDB] –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
                return { error };
            }
        };
        
        console.log('[INFO] IndexedDB —Ñ—É–Ω–∫—Ü–∏–∏ –≥–æ—Ç–æ–≤—ã. –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª–∏: window.testIndexedDB()');
        console.log('[INFO] –î–ª—è —Å–±—Ä–æ—Å–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: window.resetIndexedDB()');
    });
    
    // –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é loadUserData –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å IndexedDB
    const loadUserData = async () => {
        try {
            const telegramId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || localStorage.getItem('telegramId') || "test_user";
            
            // –í—ã–≤–æ–¥–∏–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ telegramId
            console.log(`[DEBUG] –¢–∏–ø telegramId: ${typeof telegramId}, –∑–Ω–∞—á–µ–Ω–∏–µ: ${telegramId}`);
            
            console.log(`[API] –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${telegramId} —Å —Å–µ—Ä–≤–µ—Ä–∞...`);
            const response = await fetch("https://test.tonion.io/wheel.php?action=getScores", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ telegramId })
            });
            const data = await response.json();

            if (data.success) {
                console.log("[API] –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞:", data);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—á–∫–æ–≤
                onionDisplay.textContent = data.onion;
                candyDisplay.textContent = data.candy;
                junkDisplay.textContent = data.junk;
                coinDisplay.textContent = data.coin;
                
                spinsLeft = data.spinsLeft;
                userStreak = data.streak || 0; // –ü–æ–ª—É—á–∞–µ–º streak –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –≤ IndexedDB
                try {
                    // –ì–æ—Ç–æ–≤–∏–º –æ–±—ä–µ–∫—Ç —Å —Ä–µ—Å—É—Ä—Å–∞–º–∏
                    const resources = {
                        onion: data.onion,
                        candy: data.candy,
                        junk: data.junk,
                        coin: data.coin,
                        streak: data.streak || 0,
                        spinsLeft: data.spinsLeft
                    };
                    
                    console.log(`[IndexedDB] –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—é –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${telegramId}`);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ IndexedDB
                    await saveUserResources(telegramId, resources);
                    
                    // –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é)
                    const history = await getResourcesHistory(telegramId, 3);
                    if (history && history.length > 0) {
                        console.log("[IndexedDB] –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤:", history);
                    }
                } catch (dbError) {
                    console.error("[IndexedDB] –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö:", dbError);
                }
                
                // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                console.log(`[DEBUG] ========= User Data Debug Info =========`);
                console.log(`[DEBUG] Streak: ${userStreak}`);
                console.log(`[DEBUG] Last login: ${data.lastLogin}`);
                console.log(`[DEBUG] Current date: ${data.currentDate}`);
                console.log(`[DEBUG] Server time: ${data.serverTime}`);
                console.log(`[DEBUG] ========================================`);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π —Å–ø–∏–Ω
                if (data.pendingSpin === 1) {
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π —Å–ø–∏–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                    showModal("You have a pending spin. Please reload the page to complete it.");
                    spinBtn.disabled = true;
                    spinBtn.textContent = "Pending spin...";
                    return; // –ù–µ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å–ø–∏–Ω–∞
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ —Å–ø–∏–Ω–∞
                updateSpinButton();
            } else {
                console.error("[ERROR]: –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", data.message);
                
                // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ IndexedDB, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                try {
                    console.log("[IndexedDB] –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...");
                    const localData = await getUserResources(telegramId);
                    
                    if (localData) {
                        console.log("[IndexedDB] –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:", localData);
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—á–∫–æ–≤ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑—ã
                        onionDisplay.textContent = localData.onion;
                        candyDisplay.textContent = localData.candy;
                        junkDisplay.textContent = localData.junk;
                        coinDisplay.textContent = localData.coin;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
                        spinsLeft = localData.spinsLeft || 0;
                        userStreak = localData.streak || 0;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å–ø–∏–Ω–∞
                        updateSpinButton();
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                        showModal("Using offline data. Some features may be limited.");
                    } else {
                        console.log("[IndexedDB] –õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
                    }
                } catch (dbError) {
                    console.error("[IndexedDB] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:", dbError);
                }
            }
        } catch (error) {
            console.error("[ERROR]: –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error);
            
            // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ IndexedDB –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å–µ—Ç–∏
            const telegramId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || localStorage.getItem('telegramId') || "test_user";
            
            try {
                console.log("[IndexedDB] –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏ —Å–µ—Ç–∏...");
                const localData = await getUserResources(telegramId);
                
                if (localData) {
                    console.log("[IndexedDB] –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏ —Å–µ—Ç–∏:", localData);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—á–∫–æ–≤ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑—ã
                    onionDisplay.textContent = localData.onion;
                    candyDisplay.textContent = localData.candy;
                    junkDisplay.textContent = localData.junk;
                    coinDisplay.textContent = localData.coin;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
                    spinsLeft = localData.spinsLeft || 0;
                    userStreak = localData.streak || 0;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å–ø–∏–Ω–∞
                    updateSpinButton();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    showModal("Network error. Using offline data. Some features will be unavailable.");
                } else {
                    console.log("[IndexedDB] –õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏ —Å–µ—Ç–∏");
                    showModal("Network error. Could not load your data.");
                }
            } catch (dbError) {
                console.error("[IndexedDB] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏ —Å–µ—Ç–∏:", dbError);
                showModal("Network error. Could not access local data.");
            }
        }
    };

    // –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é spinSlider –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å IndexedDB
    const spinSlider = async () => {
        if (spinning || spinsLeft <= 0) return;

        spinning = true;
        spinBtn.disabled = true;

        // –°–Ω–∞—á–∞–ª–∞ —É–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ø–∏–Ω–æ–≤ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å–ø–µ—à–Ω–æ –ª–∏ —ç—Ç–æ —Å–¥–µ–ª–∞–Ω–æ
        const spinUpdated = await updateSpins();
        if (!spinUpdated) {
            spinning = false;
            spinBtn.disabled = false;
            return;
        }

        const randomIndex = Math.floor(Math.random() * slides.length);
        const targetIndex = randomIndex + 2 * slides.length;
        const targetOffset = -(targetIndex * slideWidth);

        sliderTrack.style.transition = "transform 4s ease-out";
        sliderTrack.style.transform = `translateX(${targetOffset}px)`;

        setTimeout(async () => {
            // const finalIndex = targetIndex % slides.length;
            const visibleSlides = 3; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∏–¥–∏–º—ã—Ö —Å–ª–∞–π–¥–æ–≤
            const finalIndex = (targetIndex + Math.floor(visibleSlides / 2)) % slides.length;
            const selectedSlide = sliderTrack.children[finalIndex];
            const type = selectedSlide.getAttribute("data-type");
            const amount = parseInt(selectedSlide.getAttribute("data-amount"));

            let totalAmount = amount;
            let bonusText = '';
            
            // –ï—Å–ª–∏ —Ç–∏–ø Onion, –ø—Ä–∏–º–µ–Ω—è–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª—å streak
            if (type === "onion" && userStreak > 0) {
                const streakBonus = calculateStreakBonus(amount, userStreak);
                totalAmount += streakBonus;
                
                // –í—ã—á–∏—Å–ª—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç –±–æ–Ω—É—Å–∞ —Å —É—á–µ—Ç–æ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
                const percentPerDay = 3;
                const maxBonusPercent = 200;
                const currentBonusPercent = Math.min(userStreak * percentPerDay, maxBonusPercent);
                const isMaxBonus = currentBonusPercent >= maxBonusPercent;
                
                bonusText = ` <span style="color: #4CAF50;">Including streak bonus +${streakBonus} [${currentBonusPercent}%${isMaxBonus ? ' MAX' : ''}] </span>`;
            }

            showModal(`Congratulations! You won ${totalAmount} ${type}!${bonusText}`);

            try {
                const telegramId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || localStorage.getItem('telegramId') || "test_user";
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                await fetch("https://test.tonion.io/wheel.php?action=updatePoints", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        telegramId, 
                        type, 
                        amount: totalAmount, 
                        baseAmount: amount,
                        streakBonus: type === "onion" ? userStreak : 0
                    })
                });

                // –û—Ç–º–µ—á–∞–µ–º —Å–ø–∏–Ω –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π
                await fetch("https://test.tonion.io/wheel.php?action=completeSpin", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ telegramId })
                });
                
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ IndexedDB
                try {
                    console.log("[IndexedDB] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –≤—ã–∏–≥—Ä—ã—à–∞...");
                    const localData = await getUserResources(telegramId);
                    
                    if (localData) {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –≤—ã–∏–≥—Ä–∞–Ω
                        const updatedResources = { ...localData };
                        updatedResources[type] = (updatedResources[type] || 0) + totalAmount;
                        updatedResources.spinsLeft = (spinsLeft > 0) ? spinsLeft - 1 : 0;
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                        await saveUserResources(telegramId, updatedResources);
                        console.log(`[IndexedDB] –î–∞–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å–æ–≤ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –ø–æ—Å–ª–µ –≤—ã–∏–≥—Ä—ã—à–∞ ${totalAmount} ${type}`);
                    } else {
                        console.log("[IndexedDB] –õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –≤—ã–∏–≥—Ä—ã—à–∞");
                    }
                } catch (dbError) {
                    console.error("[IndexedDB] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –≤—ã–∏–≥—Ä—ã—à–∞:", dbError);
                }
            } catch (error) {
                console.error("[ERROR]: Error updating user data:", error);
            }

            sliderTrack.style.transition = "none";
            sliderTrack.style.transform = `translateX(0px)`;

            spinning = false;
            await loadUserData(); // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–ø–∏–Ω–∞
        }, 4000);
    };

    // –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ IndexedDB
    document.addEventListener('DOMContentLoaded', () => {
        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ö—Ä–∞–Ω—è—â–∏—Ö—Å—è –¥–∞–Ω–Ω—ã—Ö –≤ –∫–æ–Ω—Å–æ–ª–∏
        window.debugIndexedDB = async () => {
            try {
                const telegramId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || localStorage.getItem('telegramId') || "test_user";
                console.log(`[DEBUG] –û—Ç–ª–∞–¥–∫–∞ IndexedDB –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${telegramId}`);
                
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Ä–µ—Å—É—Ä—Å—ã
                const resources = await getUserResources(telegramId);
                console.log("[DEBUG] –¢–µ–∫—É—â–∏–µ —Ä–µ—Å—É—Ä—Å—ã:", resources);
                
                // –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π
                const history = await getResourcesHistory(telegramId, 10);
                console.log("[DEBUG] –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ä–µ—Å—É—Ä—Å–æ–≤ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10):", history);
                
                return { resources, history };
            } catch (error) {
                console.error("[DEBUG] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ª–∞–¥–∫–µ IndexedDB:", error);
                return null;
            }
        };
        
        console.log("[INFO] –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ. –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ IndexedDB –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª–∏: window.debugIndexedDB()");
    });
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º Telegram ID –≤ localStorage –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', () => {
        const telegramId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || localStorage.getItem('telegramId');
        if (telegramId) {
            localStorage.setItem('telegramId', telegramId);
            
            // –õ–æ–≥–∏—Ä—É–µ–º –≤—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            logUserAccess(telegramId);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            updateUserUsername(telegramId);
        } else {
            console.error('[ERROR]: Telegram ID –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.');
        }
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function logUserAccess(telegramId) {
        // –°–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
        const userAgent = navigator.userAgent;
        const deviceInfo = {
            userAgent: userAgent,
            platform: navigator.platform,
            vendor: navigator.vendor,
            screenSize: `${window.screen.width}x${window.screen.height}`
        };
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        fetch('log_access.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                telegram_id: telegramId,
                device_info: JSON.stringify(deviceInfo),
                page: 'webapp.html'
            })
        }).catch(error => {
            // –¢–∏—Ö–∞—è –æ—à–∏–±–∫–∞ - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function updateUserUsername(telegramId) {
        try {
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
            const telegramUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
            let username = null;
            
            if (telegramUser) {
                // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
                if (telegramUser.username) {
                    username = telegramUser.username;
                } else if (telegramUser.first_name) {
                    // –ï—Å–ª–∏ –Ω–µ—Ç username, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    username = telegramUser.first_name;
                    if (telegramUser.last_name) {
                        username += ' ' + telegramUser.last_name;
                    }
                }
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ username
            const response = await fetch("https://test.tonion.io/wheel.php?action=updateUsername", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    telegramId, 
                    username 
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                console.log(`[USERNAME] ${data.message}: ${data.username || 'null'}`);
            } else {
                console.error("[ERROR]: Error updating username:", data.message || data.error);
            }
        } catch (error) {
            console.error("[ERROR]: Error updating username:", error);
        }
    }

    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ —Ñ–æ–Ω–∞ –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞
    const applyCustomHeaderTheme = () => {
        if (typeof Telegram !== "undefined" && Telegram.WebApp) {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç –≤–µ—Ä—Ö–Ω–µ–π —Ä–∞–º–∫–∏
            Telegram.WebApp.setHeaderColor("#0a0514"); // –≤–µ—Ä—Ö–Ω–∞—è —Ä–∞–º–∫–∞
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –≤ —Ä–∞–º–∫–µ (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
            Telegram.WebApp.setBackgroundColor("#0a0514"); // –§–æ–Ω –∑–∞–≥–æ–ª–æ–≤–∫–∞/ –Ω–∏–∂–Ω–∞—è —Ä–∞–º–∫–∞
            Telegram.WebApp.setHeaderTextColor("#0ff"); // –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞

            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —ç–∫—Å–ø–∞–Ω–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            if (Telegram.WebApp.expand) {
                Telegram.WebApp.expand();
            }

            console.log("Custom header and background colors applied.");
        } else {
            console.warn("Telegram WebApp API is not available.");
        }
    };

    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener("DOMContentLoaded", () => {
        applyCustomHeaderTheme();

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞
        init();
    });

    let spinsLeft = 5; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –ø—Ä–æ–∫—Ä—É—Ç–æ–≤
    let timerInterval = null; // –¢–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á—ë—Ç–∞
    let refreshTimer = null; // –¢–∞–π–º–µ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    let spinning = false; // –£–∫–∞–∑—ã–≤–∞–µ—Ç, –∏–¥—ë—Ç –ª–∏ –≤—Ä–∞—â–µ–Ω–∏–µ
    const telegramId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || "test_user";
    let userStreak = 0; // –¢–µ–∫—É—â–∏–π streak –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const sliderTrack = document.getElementById("sliderTrack");
    const spinBtn = document.getElementById("spinBtn");
    const onionDisplay = document.getElementById("onion");
    const candyDisplay = document.getElementById("candy");
    const junkDisplay = document.getElementById("junk");
    const coinDisplay = document.getElementById("coin");
    // const tonpointsDisplay = document.getElementById("tonpoints");
    const modal = document.getElementById("modal");
    const modalText = document.getElementById("modal-text");
    const closeModal = document.getElementById("close-modal");

    // –°–ª–∞–π–¥—ã
    const slides = [
        { src: "source/images/onion.png", value: "10 Onion", type: "onion", amount: 10 },
        { src: "source/images/candy.png", value: "Candy", type: "candy", amount: 1 },
        // { src: "source/images/TONpoints.PNG", value: "10 TONpts", type: "tonpoints", amount: 10 },
        { src: "source/images/Junk.png", value: "Junk", type: "junk", amount: 1 },
        { src: "source/images/onion.png", value: "10 Onion", type: "onion", amount: 10 },
        { src: "source/images/onion.png", value: "50 Onion", type: "onion", amount: 50 },
        { src: "source/images/Junk.png", value: "Junk", type: "junk", amount: 1 },
        { src: "source/images/onion.png", value: "10 Onion", type: "onion", amount: 10 },
        { src: "source/images/candy.png", value: "Candy", type: "candy", amount: 1 },
        { src: "source/images/onion.png", value: "10 Onion", type: "onion", amount: 10 },
        { src: "source/images/golden onion coin420x420.png", value: "Coin", type: "coin", amount: 1 }
    ];

    const slideWidth = 100; // –®–∏—Ä–∏–Ω–∞ –æ–¥–Ω–æ–≥–æ —Å–ª–∞–π–¥–∞
    const streakDisplay = document.getElementById("streak");

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –±–æ–Ω—É—Å–∞ –æ—Ç streak
    const calculateStreakBonus = (baseAmount, streak) => {
        if (streak <= 0) return 0;
        
        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å –¥–æ 200%
        const maxBonusPercent = 200;
        const percentPerDay = 3;
        const currentBonusPercent = Math.min(streak * percentPerDay, maxBonusPercent);
        
        return Math.floor(baseAmount * (currentBonusPercent / 100));
    };


    const updateStreak = async () => {
        try {
            const response = await fetch("https://test.tonion.io/wheel.php?action=updateStreak", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ telegramId })
            });
            const data = await response.json();

            if (data.success) {
                userStreak = data.streak || 0;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å–±—Ä–æ—Å–µ/—É–≤–µ–ª–∏—á–µ–Ω–∏–∏ —Å—Ç—Ä–∏–∫–∞
                if (data.message && data.message !== 'You have already logged in today.' && data.message !== 'Too early for streak update.') {
                    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∑–Ω–∞—á–µ–Ω–∏—è —Å—Ç—Ä–∏–∫–∞
                    const percentPerDay = 3;
                    const maxBonusPercent = 200;
                    const currentBonusPercent = Math.min(userStreak * percentPerDay, maxBonusPercent);
                    const isMaxBonus = currentBonusPercent >= maxBonusPercent;
                    const streakBonus = userStreak > 0 ? `<span style="color: #4CAF50;">   +(${currentBonusPercent}%${isMaxBonus ? ' MAX' : ''})</span>` : '';
                    
                    if (data.message === 'Streak increased!') {
                        showModal(`Welcome back! Your streak has increased to ${userStreak} days! ${streakBonus}`);
                    } else if (data.message === 'Streak reset.') {
                        showModal(`Welcome back! Your streak has been reset because you missed yesterday. New streak: 1 <span style="color: #4CAF50;">   +(3%)</span>`);
                    } else if (data.message === 'Streak reset due to long absence.') {
                        showModal(`Welcome back! Your streak has been reset due to long absence (>48h). New streak: 1 <span style="color: #4CAF50;">   +(3%)</span>`);
                    }
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ø–∏–Ω–æ–≤
                await loadUserData();
            } else if (data.error) {
                console.error("[ERROR]: Error updating streak:", data.error);
            }
        } catch (error) {
            console.error("[ERROR]: Error updating streak:", error);
        }
    };

    const init = async () => {
        await updateStreak(); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º streak (–∏ —Å–ø–∏–Ω—ã)
        createSlider();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π —Å–ø–∏–Ω
        try {
            const response = await fetch("https://test.tonion.io/wheel.php?action=checkPendingSpin", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ telegramId })
            });
            const data = await response.json();
            
            if (data.success && data.pending) {
                // –ï—Å—Ç—å –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π —Å–ø–∏–Ω, –∑–∞–≤–µ—Ä—à–∞–µ–º –µ–≥–æ —Å–ª—É—á–∞–π–Ω—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
                showModal("Unfinished spin detected. Completing it with a random result...");
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                const randomIndex = Math.floor(Math.random() * slides.length);
                const type = slides[randomIndex].type;
                const amount = slides[randomIndex].amount;
                
                let totalAmount = amount;
                let bonusText = '';
                
                // –ï—Å–ª–∏ —Ç–∏–ø Onion, –ø—Ä–∏–º–µ–Ω—è–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª—å streak
                if (type === "onion" && userStreak > 0) {
                    const streakBonus = calculateStreakBonus(amount, userStreak);
                    totalAmount += streakBonus;
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç –±–æ–Ω—É—Å–∞ —Å —É—á–µ—Ç–æ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
                    const percentPerDay = 3;
                    const maxBonusPercent = 200;
                    const currentBonusPercent = Math.min(userStreak * percentPerDay, maxBonusPercent);
                    const isMaxBonus = currentBonusPercent >= maxBonusPercent;
                    
                    bonusText = ` <span style="color: #4CAF50;">Including streak bonus +${streakBonus} [${currentBonusPercent}%${isMaxBonus ? ' MAX' : ''}] </span>`;
                }
                
                // –ù–∞—á–∏—Å–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                try {
                    await fetch("https://test.tonion.io/wheel.php?action=updatePoints", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ 
                            telegramId, 
                            type, 
                            amount: totalAmount, 
                            baseAmount: amount,
                            streakBonus: type === "onion" ? userStreak : 0
                        })
                    });
                    
                    // –û—Ç–º–µ—á–∞–µ–º —Å–ø–∏–Ω –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π
                    await fetch("https://test.tonion.io/wheel.php?action=completeSpin", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ telegramId })
                    });
                    
                    showModal(`The unfinished spin has been automatically completed. Result: ${totalAmount} ${type}!${bonusText}`);
                } catch (error) {
                    console.error("[ERROR]: –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–≥–æ —Å–ø–∏–Ω–∞:", error);
                }
            }
        } catch (error) {
            console.error("[ERROR]: –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–≥–æ —Å–ø–∏–Ω–∞:", error);
        }
        
        await loadUserData();
        setupAutoRefresh();
        loadLeaderboard();
    };


    // –°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–∞–π–¥–µ—Ä–∞
    const createSlider = () => {
        sliderTrack.innerHTML = "";
        for (let i = 0; i < 10; i++) {
            slides.forEach(slide => {
                const slideElem = document.createElement("div");
                slideElem.className = "slide";
                slideElem.setAttribute("data-type", slide.type);
                slideElem.setAttribute("data-amount", slide.amount);
                slideElem.innerHTML = `
                    <img src="${slide.src}" alt="${slide.value}">
                    <span>${slide.value}</span>
                `;
                sliderTrack.appendChild(slideElem);
            });
        }
    };
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    spinBtn.disabled = true;

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–æ–∫—Ä—É—Ç–æ–≤
    const updateSpins = async () => {
        try {
            const response = await fetch("https://test.tonion.io/wheel.php?action=updateSpins", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ telegramId })
            });
            
            const data = await response.json();

            if (data.success) {
                spinsLeft -= 1;
                updateSpinButton();
                return true;
            } else {
                if (data.pending) {
                    showModal("You have a pending spin. Please reload the page to complete it.");
                } else {
                    console.error("[ERROR]: Error updating spins:", data.message);
                }
                return false;
            }
        } catch (error) {
            console.error("[ERROR]: –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–∫—Ä—É—Ç–æ–≤:", error);
            return false;
        }
    };

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ Spin
    const updateSpinButton = () => {
        if (spinsLeft > 0) {
            spinBtn.disabled = false;
            spinBtn.textContent = `Spin (${spinsLeft} left)`;
        } else {
            spinBtn.disabled = true;
            spinBtn.textContent = "No spins left";
        }
    };

    const loadLeaderboard = async (sortField = 'onion') => {
        try {
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Å–µ–ª–µ–∫—Ç–µ
            const leaderboardSort = document.getElementById("leaderboard-sort");
            if (leaderboardSort) {
                leaderboardSort.value = sortField;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∫–æ–ª–æ–Ω–∫–∏
            const headers = {
                'onion': document.getElementById('header-onion'),
                'streak': document.getElementById('header-streak'),
                'total_referrals': document.getElementById('header-referrals')
                // 'tonpoints': document.getElementById('header-tonpoints')
            };
            
            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
            Object.values(headers).forEach(header => {
                if (header) header.classList.remove('active-sort');
            });
            
            // –í—ã–¥–µ–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
            const activeHeader = headers[sortField];
            if (activeHeader) activeHeader.classList.add('active-sort');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –ø–æ–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            const response = await fetch("https://test.tonion.io/wheel.php?action=getLeaderboard", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ sortField })
            });
            
            const data = await response.json();

            if (data.success) {
                const leaderboardTable = document.getElementById("leaderboard-body");
                leaderboardTable.innerHTML = ""; // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ

                data.leaderboard.forEach((user, index) => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${user.username || "Anonymous"}</td>
                        <td>${user.onion}</td>
                        <td>${user.streak || "0"}</td>
                        <td>${user.total_referrals || "0"}</td>
                        <!-- <td>${user.tonpoints || "0"}</td> -->
                    `;
                    leaderboardTable.appendChild(row);
                });
            } else {
                console.error("[ERROR]: Error loading leaderboard:", data.message);
            }
        } catch (error) {
            console.error("[ERROR]: Error requesting leaderboard data:", error);
        }
    };

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø—Ä–∏ –≤—Ö–æ–¥–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
    document.addEventListener("DOMContentLoaded", () => {
        loadLeaderboard();
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º –∫–æ–ª–æ–Ω–æ–∫
        const headerMap = {
            'header-onion': 'onion',
            'header-streak': 'streak',
            'header-referrals': 'total_referrals'
            // 'header-tonpoints': 'tonpoints'
        };
        
        Object.entries(headerMap).forEach(([headerId, sortField]) => {
            const header = document.getElementById(headerId);
            if (header) {
                header.style.cursor = 'pointer'; // –ú–µ–Ω—è–µ–º –∫—É—Ä—Å–æ—Ä, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç—å
                header.addEventListener('click', () => {
                    loadLeaderboard(sortField);
                });
            }
        });
    });

    // –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    const showModal = (message) => {
        modalText.innerHTML = message; // –ò—Å–ø–æ–ª—å–∑—É–µ–º innerHTML –≤–º–µ—Å—Ç–æ textContent –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ HTML-—Ç–µ–≥–æ–≤
        modal.style.display = "flex";
    };

    closeModal.addEventListener("click", () => {
        modal.style.display = "none";
        loadUserData();
    });


    spinBtn.addEventListener("click", spinSlider);

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    function setupAutoRefresh() {
        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        refreshTimer = setInterval(() => {
            if (!spinning) { // –ù–µ –æ–±–Ω–æ–≤–ª—è–µ–º, –µ—Å–ª–∏ –∏–¥–µ—Ç –≤—Ä–∞—â–µ–Ω–∏–µ
                loadUserData();
                loadLeaderboard();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–æ—à–ª–æ –ª–∏ –≤—Ä–µ–º—è —Å–±—Ä–æ—Å–∞ (02:00)
                const currentHour = new Date().getHours();
                if (currentHour >= 2 && currentHour < 3) {
                    // –ú–µ–∂–¥—É 2:00 –∏ 3:00 –æ–±–Ω–æ–≤–ª—è–µ–º streak –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–±—Ä–æ—Å spins
                    updateStreak();
                }
            }
        }, 30000); // 30 —Å–µ–∫—É–Ω–¥
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–∑ —Å–∫—Ä—ã—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && !spinning) {
                loadUserData();
                loadLeaderboard();
            }
        });
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ –æ–∫–Ω–µ
        window.addEventListener('focus', () => {
            if (!spinning) {
                loadUserData();
                loadLeaderboard();
            }
        });
    }

    // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    init();

    </script>
</body>
</html>
