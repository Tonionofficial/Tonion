<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refer a Friend</title>
    <link rel="stylesheet" href="source/style/webapp.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="source/scripts/common.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Michroma&family=Oswald:wght@200..700&display=swap" rel="stylesheet">
</head>

<body>
    <header class="fixed-header">
        <div class="header">
            <p class="onion"> <img src="source/images/onion.png" style="height: 30px;" alt="Onion"> <span id="onion"> 0</span></p>
            <p class="candy"> <img src="source/images/candy30x30.png" alt="Candy"> <span id="candy">0</span></p>
            <p class="junk"> <img src="source/images/Junk.png" style="height: 25px;" alt="junk"><span id="junk">0</span></p>
            <p class="coin"> <img src="source/images/golden onion coin420x420.png" style="height: 26px;" alt="Coin"> <span id="coin">0</span></p>
            
        </div>

</header>
<div class="margintop"></div>

    <section class="earn">
        <div class="container">
            <div class="claimbtn">
                <h2 class="referal">Your Referral Link</h2>
                <button id="copyReferralLinkBtn" class="btn btn-primary">Claim your link</button>
                <p id="copyStatus" class="mt-2 text-success"></p>
            </div>

            <div class="yrb">
                <h2 class="referaltext">Your Referral Bonus</h2>
                <p class="referal" id="referralBonus">Loading...</p>
            </div>

            <div class="claimbtn">
                <button id="claimBonusBtn" class="btn btn-primary">Claim Referral Bonus</button>
                <p id="claimStatus" class="mt-2 text-success"></p>
            </div>

            <div class="ref-text">
                <span class="frends-img"><img src="source/images/frendsonion.png" style="width: 100%;" alt="frendsimg"></span>
                <ul class="frends-txt">
                    <li class="frends-text-li">Invite Friendsü§ù</li>
                    <li class="frends-text-li">Earn 50üßÖWhen ref. compleated basic tasks</li>
                    <li class="frends-text-li">Receive 20% of their earningsüí∏</li>
                    
                </ul>
            </div>
        </div>
    </section>

    <footer class="fixed-footer">
        <div class="buttons">
            <a class="fbtn" href="webapp.html">Slider</a>
            <a class="fbtn" href="frends.html">Friends</a>
            <a class="fbtn rpg-btn" href="source/rpg.html?v=1.1.32">RPG</a>
            <a class="fbtn" href="earn.html">Earn</a>
            <a class="fbtn disabled" href="#" onclick="return false;">Play</a>
        </div>
    </footer>

    <script>
        
                    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ —Ñ–æ–Ω–∞ –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞
                    const applyCustomHeaderTheme = () => {
        if (typeof Telegram !== "undefined" && Telegram.WebApp) {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç –≤–µ—Ä—Ö–Ω–µ–π —Ä–∞–º–∫–∏
            Telegram.WebApp.setHeaderColor("#0a0514"); // –≤–µ—Ä—Ö–Ω–∞—è —Ä–∞–º–∫–∞
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –≤ —Ä–∞–º–∫–µ (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
            Telegram.WebApp.setBackgroundColor("#0a0514"); // –§–æ–Ω –∑–∞–≥–æ–ª–æ–≤–∫–∞/ –Ω–∏–∂–Ω–∞—è —Ä–∞–º–∫–∞
            Telegram.WebApp.setHeaderTextColor("#0ff"); // –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞

            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —ç–∫—Å–ø–∞–Ω–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            if (Telegram.WebApp.expand) {
                Telegram.WebApp.expand();
            }

            console.log("Custom header and background colors applied.");
        } else {
            console.warn("Telegram WebApp API is not available.");
        }
    };

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener("DOMContentLoaded", () => {
            applyCustomHeaderTheme();

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞
            init();
        });
        
        
        
        document.addEventListener('DOMContentLoaded', async () => {
            const API_URL = "https://test.tonion.io/frends.php";
            let telegramId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
            let refreshTimer = null; // –¢–∞–π–º–µ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            let isClaimingBonus = false; // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

            if (!telegramId) {
                telegramId = localStorage.getItem('telegramId');
                if (!telegramId) {
                    console.error('[ERROR]: Telegram ID is missing.');
                    return;
                }
            }

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
            function setupAutoRefresh() {
                // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
                refreshTimer = setInterval(() => {
                    loadUserStats();
                    loadReferralBonus();
                }, 30000); // 30 —Å–µ–∫—É–Ω–¥
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–∑ —Å–∫—Ä—ã—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'visible') {
                        loadUserStats();
                        loadReferralBonus();
                    }
                });
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ –æ–∫–Ω–µ
                window.addEventListener('focus', () => {
                    loadUserStats();
                    loadReferralBonus();
                });
            }

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –∫ API
            async function apiRequest(action, params = {}) {
                params.action = action;
                params.telegram_id = telegramId;
                try {
                    const response = await fetch(API_URL, {
                        method: "POST",
                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                        body: new URLSearchParams(params),
                    });
                    return await response.json();
                } catch (error) {
                    console.error(`[ERROR]: –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ ${action}:`, error);
                    return null;
                }
            }

            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã
            async function loadUserStats() {
                const data = await apiRequest("getScores");
                if (data?.success) {
                    document.getElementById("onion").textContent = data.onion || 0;
                    document.getElementById("candy").textContent = data.candy || 0;
                    document.getElementById("junk").textContent = data.junk || 0;
                    document.getElementById("coin").textContent = data.coin || 0;
                } else {
                    console.error("[ERROR]: –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.");
                }
            }

            // –ó–∞–≥—Ä—É–∑–∫–∞ –±–æ–Ω—É—Å–æ–≤
            async function loadReferralBonus() {
                const data = await apiRequest("getReferralBonus");
                if (data?.success) {
                    document.getElementById("referralBonus").textContent = `Referral Bonus: ${data.referralBonus} Onions`;
                    
                    // –í–∫–ª—é—á–∞–µ–º –∏–ª–∏ –æ—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–ª–∏—á–∏—è –±–æ–Ω—É—Å–æ–≤
                    const claimBtn = document.getElementById("claimBonusBtn");
                    if (claimBtn) {
                        if (data.referralBonus > 0) {
                            claimBtn.disabled = false;
                            claimBtn.textContent = "Claim Referral Bonus";
                        } else {
                            claimBtn.disabled = true;
                            claimBtn.textContent = "No Bonus Available";
                        }
                    }
                } else {
                    console.error("[ERROR]: –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–æ–Ω—É—Å–æ–≤.");
                }
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "Claim Referral Bonus"
            async function claimReferralBonus() {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ª–∏ —É–∂–µ –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –±–æ–Ω—É—Å–∞
                if (isClaimingBonus) {
                    return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å —É–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ –Ω–∞—á–∞–ª—Å—è –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–Ω—É—Å–∞
                isClaimingBonus = true;
                
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è
                const claimBtn = document.getElementById("claimBonusBtn");
                if (claimBtn) {
                    claimBtn.disabled = true;
                    claimBtn.textContent = "Processing...";
                }

                try {
                    // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –≤ 2 —Å–µ–∫—É–Ω–¥—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∑–∞–ø—Ä–æ—Å–∞
                    await new Promise(resolve => setTimeout(resolve, 2000));

                    const data = await apiRequest("claimReferralBonus");
                    if (data?.success) {
                        document.getElementById("claimStatus").textContent = `Claim successful! Bonus: ${data.claimedBonus} Onions added.`;
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É, –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è
                        await loadUserStats(); 
                        await loadReferralBonus();
                        
                        // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–π
                        // –ø–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–Ω–æ–≤–∞ –Ω–µ –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç –±–æ–Ω—É—Å
                    } else {
                        document.getElementById("claimStatus").textContent = `Claim failed: ${data?.message || "Unknown error."}`;
                        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –∏–ª–∏ –µ—Å–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –±–æ–Ω—É—Å–∞
                        if (claimBtn) {
                            claimBtn.disabled = false;
                            claimBtn.textContent = "Claim Referral Bonus";
                        }
                    }
                } catch (error) {
                    console.error("[ERROR]: –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –±–æ–Ω—É—Å–∞:", error);
                    document.getElementById("claimStatus").textContent = "Error claiming bonus. Please try again later.";
                    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
                    if (claimBtn) {
                        claimBtn.disabled = false;
                        claimBtn.textContent = "Claim Referral Bonus";
                    }
                } finally {
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                    isClaimingBonus = false;
                }
            }

        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    document.getElementById("copyStatus").textContent = "Referral link copied!";
                }).catch(() => {
                    fallbackCopyToClipboard(text);
                });
            } else {
                fallbackCopyToClipboard(text);
            }
        }

        // **–†–µ–∑–µ—Ä–≤–Ω—ã–π –º–µ—Ç–æ–¥ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ `textarea` (–¥–ª—è Web Telegram)**
        function fallbackCopyToClipboard(text) {
            const tempInput = document.createElement("textarea");
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            try {
                document.execCommand("copy");
                document.getElementById("copyStatus").textContent = "Referral link copied!";
            } catch (err) {
                console.error("[ERROR]: Fallback copy failed:", err);
                document.getElementById("copyStatus").textContent = "Failed to copy referral link.";
            }
            document.body.removeChild(tempInput);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "Claim your link"
        async function loadReferralLink() {
            const data = await apiRequest("getReferralLink");
            if (data?.success) {
                document.getElementById("copyReferralLinkBtn").addEventListener("click", () => {
                    copyToClipboard(data.referralLink);
                });
            } else {
                document.getElementById("copyStatus").textContent = "Error generating referral link.";
            }
        }
            
          
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
            async function initialize() {
                await loadUserStats(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await loadReferralBonus(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–æ–Ω—É—Å—ã
                await loadReferralLink(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É

                document.getElementById("claimBonusBtn").addEventListener("click", claimReferralBonus);
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
                setupAutoRefresh();
            }

            // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            initialize();
        });
    </script>
</body>

</html>
